<html><head>
    <style text="text/css">
    html, body {
        padding: 0; margin: 0;
    }
    #canvas {
        width: 2000px;
        height: 2000px;
        position: absolute;
        top: 0px;
        left: 0px;
    }
    #window {
        position: absolute;
        width: 100%;
        height: 100%;
        overflow: hidden;
    }
    </style>
    </head>
    <body>
    <div id="window">
    <canvas id="canvas" width="20000" height="20000" style="cursor: default; top: -12px; left: 0px;"></canvas>
    </div>
	<!-- Подключаем jQuery, а также Socket.io -->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.4/socket.io.js"></script>
    
	<script>
		window.onload = function(){
            var socket = io.connect('http://localhost:3000'); // Подключились к серверу
            var canvas = document.getElementById('canvas');
            var ctx = canvas.getContext('2d');
            var objs = [];
            var x = -20, y = 0;
            for (var i = 1; i<=39999; i++) {
                x = x + 20;
                if (i == ((y+20)/20)*400){y = y + 20; x = 0;}
                objs.push({
	            	'x': x,
	            	'y': y,	    	
                    'r': 255,
                    'g': 255,
                    'b': 221,
                    'id': i,
	            })
                ctx.fillStyle = "rgb("+objs[i-1].r+","+objs[i-1].g+","+objs[i-1].b+")";
                ctx.fillRect(x, y, 20, 20);
            }
            var pixbase = [];
            socket.on('pixbase', function(messageObject){
                pixbase = messageObject;
                for (var i = 1; i<39999; i++) {
                    ctx.fillStyle = "rgb("+pixbase[i].r+","+pixbase[i].g+","+pixbase[i].b+")";
                    ctx.fillRect(objs[i].x, objs[i].y, 20, 20);
                }
            });
            var capture = false, cx = 0, cy = 0;
            x = 0; y = 0;
            canvas.addEventListener('mousedown', function (event) {
	            capture = true;
	            x = event.clientX;
	            y = event.clientY;
            }, false);
            canvas.addEventListener('mouseup', function () {
	            capture = false;
	            canvas.style.cursor = 'default';
            }, false);
            canvas.addEventListener('mousemove', function (event) {
	            if (capture) {
		            cx -= x - event.clientX, cy -= y - event.clientY;
		            canvas.style.top  = cy + 'px';
		            canvas.style.left = cx + 'px';
		            x = event.clientX;
		            y = event.clientY;	
	            }
            }, false);
            
                       canvas.addEventListener('click', function (event) {
                var x = event.clientX - cx, y = event.clientY - cy;
                console.log(x,y)
	            for (var i = 1; i<39999; i++) {
                    
	    	       var o = objs[i-1];
		           if (o.x < x && x < o.x + 20 && o.y < y && y < 20 + o.y) {
                    console.log(true)
                    let r = 152,g= 0,b=2;
                    var cc = "rgb("+r+","+g+","+b+")";
                    ctx.fillStyle = cc;
                    ctx.fillRect(o.x + 1 , o.y + 1, 19, 19);
                    o.r=r;
                    o.g=g;
                    o.b=b;
                    socket.emit('message',{
                     id:o.id,
                     r:r,
                     g:g,
                     b:b
                    });
                    break;
                   }
                }
            });
            socket.on('message', function(messageObject){
                
                console.log(messageObject);
                for (var i = 1; i<39999; i++) {
                   var o = objs[i];
                   var oo = messageObject.id;
                   if (o.id == oo) {
                    ctx.fillStyle = "rgb("+oo.r+","+oo.g+","+oo.b+")";
                    ctx.fillRect(o.x, o.y, 20, 20);
                    

                   }}
                 });
        };
	</script>

</body></html>
