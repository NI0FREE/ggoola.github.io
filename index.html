<html><head>
    <style text="text/css">
    html, body {
        padding: 0; margin: 0;
    }
    #canvas {
        width: 6000px;
        height: 6000px;
        position: absolute;
        top: 0px;
        left: 0px;
    }
    #window {
        position: absolute;
        width: 100%;
        height: 100%;
        overflow: hidden;
    }
    </style>
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no">
    </head>
    <body>
    <div id="window">
    <canvas id="canvas" width="6000" height="6000" style="cursor: default; top: -12px; left: 0px;"></canvas>
    </div>
	<!-- Подключаем jQuery, а также Socket.io -->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.4/socket.io.js"></script>
    
	<script>
		window.onload = function(){
            var socket = io.connect('http://localhost:3000'); // Подключились к серверу
            var canvas = document.getElementById('canvas');
            var ctx = canvas.getContext('2d');
            var objs = [];
            var x = -30, y = 0;
            for (var i = 1; i<=39999; i++) {
                x = x + 30;
                if (i == ((y+30)/30)*200){y = y + 30; x = 0;}
                objs.push({
	            	'x': x,
	            	'y': y,	    	
                    'r': 50,
                    'g': 130,
                    'b': 184,
                    'id': i,
	            })	
            }
            var pixbase = [];
            socket.on('pixbase', function(messageObject){
                pixbase = messageObject;
                for (var i = 1; i<39999; i++) {
                    ctx.fillStyle = "rgb("+pixbase[i].r+","+pixbase[i].g+","+pixbase[i].b+")";
                    ctx.fillRect(objs[i].x, objs[i].y, 30, 30);
                }
            });
            var capture = false, cx = 0, cy = 0;
            x = 0; y = 0;
	//FORPHONECAMCONTROL_START
            canvas.addEventListener('touchstart', function (event) {
	            capture = true;
	            x = event.touches[0].clientX;
	            y = event.touches[0].clientY;
            }, false);
            canvas.addEventListener('touchend', function () {
	            capture = false;
	            canvas.style.cursor = 'default';
            }, false);
            canvas.addEventListener('touchmove', function (event) {
	            if (capture) {
		            cx -= x - event.touches[0].clientX, cy -= y - event.touches[0].clientY;
		            canvas.style.top  = cy + 'px';
		            canvas.style.left = cx + 'px';
		            x = event.touches[0].clientX;
		            y = event.touches[0].clientY;	
	            }
            }, false);
            //zoom
            /*Определяем некоторые переменные*/
            var objzoom = document.getElementById('canvas');
            var scaling = false;
            var dist = 0;
            var scale_factor = 1.0;
            var curr_scale = 1.0;
            var max_zoom = 8.0;
            var min_zoom = 0.5
            /*Пишем функцию, которая определяет расстояние меж пальцами*/
            function distance (p1, p2) {
                return (Math.sqrt(Math.pow((p1.clientX - p2.clientX), 2) + Math.pow((p1.clientY - p2.clientY), 2)));
            }
            /*Ловим начало косания*/
            objzoom.addEventListener('touchstart', function(evt) {
                evt.preventDefault();
                var tt = evt.targetTouches;
                if (tt.length >= 2) {
                    dist = distance(tt[0], tt[1]);
                    scaling = true;
                } else {
                    scaling = false;
                }
            }, false);
                /*Ловим зумирование*/
            objzoom.addEventListener('touchmove', function(evt) {
                evt.preventDefault();
                var tt = evt.targetTouches;
                if (scaling) {
                    curr_scale = distance(tt[0], tt[1]) / dist * scale_factor;
                    objzoom.style.WebkitTransform = "scale(" + curr_scale + ", " + curr_scale + ")";
                }
            }, false);
                /*Ловим конец косания*/
            objzoom.addEventListener('touchend', function(evt) {
                var tt = evt.targetTouches;
                if (tt.length < 2) {
                    scaling = false;
                    if (curr_scale < min_zoom) {
                        scale_factor = min_zoom;
                    } else {
                        if (curr_scale > max_zoom) {
                            scale_factor = max_zoom;
                        } else {
                            scale_factor = curr_scale;
                        }
                    }
                    objzoom.style.WebkitTransform = "scale(" + scale_factor + ", " + scale_factor + ")";
                } else {
                scaling = true;
                }
            }, false);
            //zoomend
            //FORPHONECAMCONTROL_END
			
	     canvas.addEventListener('mousedown', function (event) {
	            capture = true;
	            x = event.clientX;
	            y = event.clientY;
            }, false);
            canvas.addEventListener('mouseup', function () {
	            capture = false;
	            canvas.style.cursor = 'default';
            }, false);
            canvas.addEventListener('mousemove', function (event) {
	            if (capture) {
		            cx -= x - event.clientX, cy -= y - event.clientY;
		            canvas.style.top  = cy + 'px';
		            canvas.style.left = cx + 'px';
		            x = event.clientX;
		            y = event.clientY;	
	            }
            }, false);
                       canvas.addEventListener('touchend', function (event) {
                var x = event.touches[0].clientX - cx, y = event.touches[0].clientY - cy;
                console.log(x,y)
                var sc;
	            for (var i = 1; i<39999; i++) {
                    
	    	       var o = objs[i-1];
		           if (o.x < x && x < o.x + 30 && o.y < y && y < 30 + o.y) {
                    console.log(true)
                    let r = 152,g= 0,b=2;
                    var cc = "rgb("+r+","+g+","+b+")";
                    ctx.fillStyle = cc;
                    ctx.fillRect(o.x , o.y, 30, 30);
                    o.r=r;
                    o.g=g;
                    o.b=b;
				   
                    socket.emit('message',{
                     id:o.id,
                     r:r,
                     g:g,
                     b:b
                    });
                    break;
                   }
                }
            });
            socket.on('message', function(messageObject){
                
                console.log(messageObject);
                for (var i = 1; i<39999; i++) {
                   var o = objs[i];
                   var oo = messageObject.id;
                   if (o.id == oo) {
                    ctx.fillStyle = "rgb("+oo.r+","+oo.g+","+oo.b+")";
                    ctx.fillRect(o.x , o.y , 30, 30);
                    

                   }}
                 });
        };
	</script>

</body></html>
